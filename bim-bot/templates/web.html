<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BIM-Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<header>
    <div class="logo-text">BIM-BOT</div>
    <p>An Arduino-Based Prototype Robot for Mining Search and Rescue Operations</p>
</header>

<nav>
    <a href="#validation">Validation</a>
    <a href="#data">Live Monitoring</a>
    <a href="#hazard">Hazard Notification</a>
</nav>

<div class="container">

<!-- VALIDATION -->
<div id="validation" class="section">
    <h2>Validation</h2>

    <div class="validation-grid">

        <div class="validation-item">
            <h3>üó∫Ô∏è Area Mapping</h3>
            <div class="status validated">Validated</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width:100%"></div>
            </div>
            <div class="details">Accurate mapping of passageways.</div>
        </div>

        <div class="validation-item">
            <h3>‚ö†Ô∏è Hazard Detection</h3>
            <div class="status validated">Validated</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width:98%"></div>
            </div>
            <div class="details">Real-time temperature & obstacle detection.</div>
        </div>

        <div class="validation-item">
            <h3>üë§ Survivor Location</h3>
            <div class="status validated">Validated</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width:95%"></div>
            </div>
            <div class="details">YOLO-based survivor detection.</div>
        </div>

    </div>
</div>

<!--LIVE MONITORING -->
<div id="data" class="section">
    <h2>Live Operations Monitoring</h2>

    <div class="map-camera-wrapper">

        <!-- CAMERA -->
        <div>
            <h3 style="text-align:center;">üé• Recorded Exploration Camera</h3>
            <iframe 
                id="camStream"
                class="camera-feed"
                src="http://192.168.4.1/stream"
                allow="camera">
            </iframe>

            <div class="camera-controls">
                <button class="cam-btn record-btn" onclick="startRecording()">‚è∫ Record</button>
                <button class="cam-btn stop-btn" onclick="stopRecording()">‚èπ Stop</button>
            </div>

            <div id="camStatus" class="camera-status">Status: Live</div>
        </div>

        <!-- GENERATE AREA MAP -->
        <div>
            <h3 style="text-align:center;">üó∫Ô∏è Generate Area Map</h3>
            <div class="map-placeholder">
                Upload a recorded exploration video to generate an area map
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="videoUpload" name="video" accept="video/*" required>
                <button type="submit">Upload the recorded exploration video</button>
            </form>

            <div id="uploadMessage" style="margin-top:10px;color:green;"></div>

        </div>

    </div>
</div>

<!--HAZARD NOTIFICATION -->
<div id="hazard" class="section">
    <h2>Hazard Notification</h2>

    <div class="hazard-box">
        <p id="hazardStatus">No temperature and humidity data detected. Check and turn on the BIM-BOT.</p>

        <h3 id="tempDisplay">Temperature: -- ¬∞C</h3>
        <h3 id="humDisplay">Humidity: -- %</h3>

        <div id="riskLevel"></div>
        <div id="hazardTime" class="timestamp"></div>
    </div>
</div>

</div>

<!-- SCRIPTS -->
<script>
let mediaRecorder;
let recordedChunks = [];

const form = document.getElementById("uploadForm");
const messageDiv = document.getElementById("uploadMessage");

// UPLOAD VIDEO
form.addEventListener("submit", async (e) => {
    e.preventDefault(); // Prevent page reload

    const fileInput = document.getElementById("videoUpload");
    if (fileInput.files.length === 0) {
        alert("Please select a file to upload.");
        return;
    }

    const formData = new FormData();
    formData.append("video", fileInput.files[0]);

    try {
        const response = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            messageDiv.innerText = "‚úÖ Upload successful!";
        } else {
            messageDiv.innerText = "‚ùå Upload failed. Please try again.";
        }
    } catch (err) {
        messageDiv.innerText = "‚ùå Error uploading file: " + err;
    }
});


// RECORDING
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: "video/webm" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "bimbot_exploration.webm";
            a.click();
        };

        mediaRecorder.start();
        document.getElementById("camStatus").innerText = "Status: Recording...";
    } catch (err) {
        alert("Recording permission denied.");
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        document.getElementById("camStatus").innerText = "Status: Saved Recording";
    }
}

// LIVE HAZARD DATA FROM ESP32 

async function fetchHazardData() {
    try {
        const res = await fetch("http://192.168.4.1/sensor");
        const data = await res.json();

        const temp = data.temperature;
        const hum = data.humidity;

        const risk = classifyRisk(temp, hum);
        const now = new Date().toLocaleString();

        document.getElementById("hazardStatus").innerText = "Live Hazard Data Detected";
        document.getElementById("tempDisplay").innerText = `Temperature: ${temp} ¬∞C`;
        document.getElementById("humDisplay").innerText = `Humidity: ${hum} %`;
        document.getElementById("riskLevel").innerHTML = `<span class="${risk.cls}">${risk.label}</span>`;
        document.getElementById("hazardTime").innerText = `Last Update: ${now}`;

    } catch (err) {
        document.getElementById("hazardStatus").innerText = "No temperature and humidity data detected. Check and turn on the BIM-BOT.";
        document.getElementById("tempDisplay").innerText = "Temperature: -- ¬∞C";
        document.getElementById("humDisplay").innerText = "Humidity: -- %";
        document.getElementById("riskLevel").innerHTML = "";
        document.getElementById("hazardTime").innerText = "";
    }
}

setInterval(fetchHazardData, 2000);

</script>

<footer>
    <p>¬© 2025 BIM-Bot Project</p>
</footer>

</body>
</html>
